variables:
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_SUBMODULE_DEPTH: 4

stages:
  - verify

build_and_test:
  stage: verify
  rules:
    - if: >
        $CI_PIPELINE_SOURCE == "web" || 
        $CI_PIPELINE_SOURCE == "api" || 
        $CI_PIPELINE_SOURCE == "merge_request_event" ||
        $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: always
    - when: never
  parallel:
    matrix:
      - PRESET:
          - debug_linux_gcc
          - debug_linux_gcc_x32
          - debug_linux_clang
        SYSTEM_TAG: linux
        CONFIG: Debug
      - PRESET: sanitize_linux_clang
        SYSTEM_TAG: linux
        CONFIG: Debug
        CTEST_FLAG_0: -LE
        CTEST_FLAG_1: GRAPHICS
      - PRESET:
          - release_linux_gcc
          - release_linux_gcc_x32
          - release_linux_clang
        SYSTEM_TAG: linux
        CONFIG: Release
      - PRESET:
          - debug_windows_ninja_msvc
          - debug_windows_ninja_clang
        SYSTEM_TAG: windows
        CONFIG: Debug
        CTEST_FLAG_0: -LE
        CTEST_FLAG_1: GRAPHICS
      - PRESET:
          - release_windows_ninja_msvc
          - release_windows_ninja_clang
        SYSTEM_TAG: windows
        CONFIG: Release
        CTEST_FLAG_0: -LE
        CTEST_FLAG_1: GRAPHICS
  tags:
    - $SYSTEM_TAG
  script:
    - cmake --preset $PRESET -B build/ci
    - cd build/ci
    - cmake --build . --target kan_clang_format_fix --config $CONFIG
    - cmake --build . --target test_kan --config $CONFIG -j 5
    - ctest --build-config $CONFIG --parallel 5 --output-on-failure $CTEST_FLAG_0 $CTEST_FLAG_1
  artifacts:
    name: test_logs_$PRESET
    expire_in: 1 week
    paths:
      - build/ci/Testing/Temporary
